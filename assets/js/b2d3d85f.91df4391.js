"use strict";(self.webpackChunkmigrations=self.webpackChunkmigrations||[]).push([[669],{3905:function(n,e,t){t.d(e,{Zo:function(){return g},kt:function(){return p}});var r=t(7294);function o(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function i(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function a(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?i(Object(t),!0).forEach((function(e){o(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function l(n,e){if(null==n)return{};var t,r,o=function(n,e){if(null==n)return{};var t,r,o={},i=Object.keys(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||(o[t]=n[t]);return o}(n,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(o[t]=n[t])}return o}var m=r.createContext({}),s=function(n){var e=r.useContext(m),t=e;return n&&(t="function"==typeof n?n(e):a(a({},e),n)),t},g=function(n){var e=s(n.components);return r.createElement(m.Provider,{value:e},n.children)},c={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},u=r.forwardRef((function(n,e){var t=n.components,o=n.mdxType,i=n.originalType,m=n.parentName,g=l(n,["components","mdxType","originalType","parentName"]),u=s(t),p=o,d=u["".concat(m,".").concat(p)]||u[p]||c[p]||i;return t?r.createElement(d,a(a({ref:e},g),{},{components:t})):r.createElement(d,a({ref:e},g))}));function p(n,e){var t=arguments,o=e&&e.mdxType;if("string"==typeof n||o){var i=t.length,a=new Array(i);a[0]=u;var l={};for(var m in e)hasOwnProperty.call(e,m)&&(l[m]=e[m]);l.originalType=n,l.mdxType="string"==typeof n?n:o,a[1]=l;for(var s=2;s<i;s++)a[s]=t[s];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},1379:function(n,e,t){t.r(e),t.d(e,{frontMatter:function(){return l},contentTitle:function(){return m},metadata:function(){return s},toc:function(){return g},default:function(){return u}});var r=t(7462),o=t(3366),i=(t(7294),t(3905)),a=["components"],l={sidebar_position:3},m="Mongo",s={unversionedId:"mongo",id:"mongo",isDocsHomePage:!1,title:"Mongo",description:"| Repo:| github.com/jamillosantos/migrations-mongo |",source:"@site/docs/03_mongo.md",sourceDirName:".",slug:"/mongo",permalink:"/migrations/mongo",editUrl:"https://github.com/jamillosantos/migrations/edit/main/website/docs/03_mongo.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Creating Migrations",permalink:"/migrations/sql/creating-a-new-migration"},next:{title:"Functions",permalink:"/migrations/functions"}},g=[{value:"Creating a migration",id:"creating-a-migration",children:[],level:2}],c={toc:g};function u(n){var e=n.components,t=(0,o.Z)(n,a);return(0,i.kt)("wrapper",(0,r.Z)({},c,t,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"mongo"},"Mongo"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Repo:"),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"th",href:"https://github.com/jamillosantos/migrations-mongo"},"github.com/jamillosantos/migrations-mongo"))))),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"migrations-mongo")," implements a ",(0,i.kt)("inlineCode",{parentName:"p"},"Source")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Target")," for MongoDB."),(0,i.kt)("h2",{id:"creating-a-migration"},"Creating a migration"),(0,i.kt)("p",null,"First, you need to start creating your migrations. Below, you can see an example of a migration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'// Filename: 20230803204512_add_index_to_users_updated_at.go\n\npackage migrations\n\nimport (\n    "context"\n\n    . "github.com/jamillosantos/migrations-fnc" // <- provides the Migration function.\n    "go.mongodb.org/mongo-driver/mongo"\n    "go.mongodb.org/mongo-driver/mongo/options"\n)\n\nvar _ = Migration(func(ctx context.Context) error {\n    // DB should be a global variable initialized before the migration runs.\n    c := DB.Collection("users") // Get the `users` collection.\n    \n    // Create the index.\n    _, err := c.Indexes().CreateOne(ctx, mongo.IndexModel{\n        Keys: map[string]int{"updated_at": 1},\n        Options: (&options.IndexOptions{}).\n            SetName("idx_users_updated_at"),\n    })\n    return err\n})\n')),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"As you can see, the ",(0,i.kt)("inlineCode",{parentName:"p"},"migrations-mongo")," uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"migrations-fnc")," package to create the migrations.")),(0,i.kt)("p",null,"You can have a file initialized with a different name pattern to declare the ",(0,i.kt)("inlineCode",{parentName:"p"},"DB")," variable:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'// Filename: migrations/db.go\n\npackage migrations\n\nimport (\n    "go.mongodb.org/mongo-driver/mongo"\n)\n\nvar (\n    // DB is the global database connection that will be used by the migrations.\n    DB *mongo.Database\n)\n')),(0,i.kt)("p",null,"To run the migration you can:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'// ...\n\n// Start a new mongo connection\nclient, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://guest:guest@localhost:27017"))\nif err != nil {\n    _, _ = fmt.Fprintf(os.Stderr, "failed to connect with mongo: %s\\n", err.Error())\n    os.Exit(1)\n}\n// -----\n\ndb := client.Database("example")\n\n// Initialize the DB that will be used in the migrations.\nexamplemigrations.DB = db\n\n// Create the target where the migrations will run.\ntarget, err := migrationsmongo.NewTarget(migrations.DefaultSource, db)\nif err != nil {\n    _, _ = fmt.Fprintf(os.Stderr, "failed to initialize target: %s\\n", err)\n    os.Exit(1)\n}\n\n// runner is responsible for planning and running the migrations.\nrunner := migrations.NewRunner(migrations.DefaultSource, target)\n\nreporter := migrationszap.NewRunnerReport(logger) // If you do not use zap, you can implement your own reporter.\n\n// Run the migrations.\n_, err = migrations.Migrate(ctx, runner, reporter)\nif err != nil {\n    _, _ = fmt.Fprintf(os.Stderr, "failed to migrate: %s\\n", err)\n    os.Exit(1)\n}\n\n// ...\n')),(0,i.kt)("p",null,"You can see the full example ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/jamillosantos/migrations-mongo/tree/main/internal/example"},"here"),"."))}u.isMDXComponent=!0}}]);